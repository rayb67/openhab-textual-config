rule "Haust√ºr klingelt"
when
    Item Fritz_IncomingCall changed
then
    if (Fritz_IncomingCall.state == NULL || Fritz_IncomingCall.state == UNDEF) return

    // AVM liefert manchmal String, manchmal CallType
    val raw = Fritz_IncomingCall.state.toString

    // Format: 0123456789,**620   oder   **610,**620
    if (!raw.contains(",")) return

    val parts = raw.split(",")
    if (parts.length < 2) return

    val caller = parts.get(0)
    val target = parts.get(1)

    logInfo("HAUSTUER", "Call from " + caller + " to " + target)

    // Haust√ºr = **610 oder T√ºr-Rufnummer
    if (caller == "**610" || caller.endsWith("0933377")) {

        Fritz_Haustuer_Status.postUpdate("üîî Es klingelt an der Haust√ºr")
        Fritz_Haustuer_Klingel.sendCommand(ON)

        createTimer(now.plusSeconds(15), [ |
            Fritz_Haustuer_Status.postUpdate("Bereit")
            Fritz_Haustuer_Klingel.sendCommand(OFF)
        ])
    }
end

